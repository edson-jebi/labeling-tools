<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>CVAT Labeling Tools</title>

    <!-- Preload critical fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <style>
        /* ============================================================================
           CVAT Labeling Tools - Apple-Inspired Design System
           ============================================================================ */

        /* ---- CSS Custom Properties (Design Tokens) ---- */
        :root {
            /* Colors - Refined Apple Pro palette with sophisticated muted tones */
            --color-primary: #0071E3;
            --color-primary-hover: #0077ED;
            --color-primary-light: rgba(0, 113, 227, 0.08);
            --color-primary-subtle: rgba(0, 113, 227, 0.04);
            --color-success: #28A745;
            --color-success-hover: #218838;
            --color-success-light: rgba(40, 167, 69, 0.08);
            --color-warning: #FF9F0A;
            --color-warning-hover: #E8900A;
            --color-warning-light: rgba(255, 159, 10, 0.08);
            --color-danger: #DC3545;
            --color-danger-hover: #C82333;
            --color-danger-light: rgba(220, 53, 69, 0.08);
            --color-purple: #8B5CF6;
            --color-purple-light: rgba(139, 92, 246, 0.08);

            /* Backgrounds - Warmer, more refined neutrals */
            --color-bg-primary: #FFFFFF;
            --color-bg-secondary: #F5F5F7;
            --color-bg-tertiary: #E8E8ED;
            --color-bg-elevated: #FFFFFF;
            --color-bg-hover: #FAFAFA;

            /* Text - Better contrast ratios for accessibility */
            --color-text-primary: #1D1D1F;
            --color-text-secondary: #86868B;
            --color-text-tertiary: #A1A1A6;
            --color-text-quaternary: #C7C7CC;
            --color-text-inverse: #FFFFFF;

            /* Borders & Separators - More nuanced */
            --color-separator: rgba(0, 0, 0, 0.06);
            --color-separator-medium: rgba(0, 0, 0, 0.10);
            --color-separator-strong: rgba(0, 0, 0, 0.16);
            --color-separator-opaque: #D2D2D7;

            /* Typography - Apple's precise SF Pro scale with dramatic jumps */
            --font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            --font-size-xs: 11px;      /* Caption 2 */
            --font-size-sm: 13px;      /* Caption 1 */
            --font-size-base: 15px;    /* Footnote */
            --font-size-md: 17px;      /* Body */
            --font-size-lg: 22px;      /* Title 3 - increased from 20px */
            --font-size-xl: 28px;      /* Title 2 - increased from 24px */
            --font-size-2xl: 34px;     /* Title 1 */
            --font-size-3xl: 40px;     /* Large Title - increased from 34px */
            --font-size-hero: 56px;    /* For statistics/key numbers */

            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Letter spacing - Apple's precise tracking */
            --letter-spacing-tight: -0.022em;
            --letter-spacing-normal: 0;
            --letter-spacing-wide: 0.012em;

            --line-height-tight: 1.1;      /* For large display text */
            --line-height-snug: 1.2;       /* For headings */
            --line-height-normal: 1.4;     /* For UI text */
            --line-height-relaxed: 1.5;    /* For body copy */
            --line-height-loose: 1.7;      /* For long-form reading */

            /* Spacing - 4px base unit with more generous values */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 24px;      /* Increased from 20px */
            --space-6: 32px;      /* Increased from 24px */
            --space-8: 48px;      /* Increased from 32px */
            --space-10: 64px;     /* Increased from 40px */
            --space-12: 80px;     /* Increased from 48px */
            --space-16: 128px;    /* Increased from 64px */

            /* Border Radius - Apple's current scale */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            --radius-full: 9999px;

            /* Shadows - Ultra-subtle Apple-inspired system */
            --shadow-xs: 0 1px 1px rgba(0, 0, 0, 0.02);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 8px 32px rgba(0, 0, 0, 0.10), 0 4px 8px rgba(0, 0, 0, 0.05);

            /* Colored shadows for interactive elements */
            --shadow-primary: 0 2px 8px rgba(0, 113, 227, 0.15);
            --shadow-focus: 0 0 0 4px var(--color-primary-light);

            /* Transitions - faster, more responsive */
            --transition-fast: 0.12s ease;
            --transition-base: 0.2s ease;
            --transition-slow: 0.25s ease;
            --transition-spring: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);

            /* Z-index scale */
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-modal-backdrop: 900;
            --z-modal: 1000;
            --z-toast: 1100;
        }


        /* ---- Reset & Base ---- */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            line-height: var(--line-height-normal);
            color: var(--color-text-primary);
            background: var(--color-bg-secondary);
            min-height: 100vh;
        }

        /* Focus states for keyboard navigation */
        body.keyboard-nav *:focus {
            outline: none;
            box-shadow: 0 0 0 4px var(--color-primary-light), 0 0 0 2px var(--color-primary);
        }

        body:not(.keyboard-nav) *:focus {
            outline: none;
        }

        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-primary);
            color: var(--color-text-inverse);
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-md);
            font-weight: var(--font-weight-semibold);
            z-index: var(--z-toast);
            transition: top var(--transition-base);
        }

        .skip-link:focus {
            top: var(--space-4);
        }

        /* ---- Layout - More generous whitespace ---- */
        .app-container {
            max-width: 1040px;
            margin: 0 auto;
            padding: var(--space-8) var(--space-6);
        }

        @media (max-width: 768px) {
            .app-container {
                padding: var(--space-5) var(--space-4);
            }
        }

        /* ---- Header - Clean, minimal ---- */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-5);
            background: var(--color-bg-primary);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-6);
            border: 1px solid var(--color-separator);
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .app-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-purple));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .app-logo-text {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            letter-spacing: var(--letter-spacing-tight);
        }

        .app-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            background: var(--color-success-light);
            color: var(--color-success);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .app-status.disconnected {
            background: var(--color-bg-tertiary);
            color: var(--color-text-secondary);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ---- Main Card ---- */
        .main-card {
            background: var(--color-bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-separator);
            overflow: hidden;
        }

        /* ---- Segmented Control (Tabs) - Lighter underline style ---- */
        .segmented-control {
            display: flex;
            background: transparent;
            padding: 0;
            margin: var(--space-5) var(--space-5) var(--space-6);
            border-bottom: 1px solid var(--color-separator);
            position: relative;
            gap: var(--space-6);
        }

        .segment-btn {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) 0;
            background: transparent;
            border: none;
            border-radius: 0;
            color: var(--color-text-secondary);
            font-family: inherit;
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: color var(--transition-fast);
            position: relative;
        }

        .segment-btn:hover {
            color: var(--color-text-primary);
        }

        .segment-btn.active {
            color: var(--color-text-primary);
            font-weight: var(--font-weight-semibold);
        }

        /* Active indicator - thin line at bottom */
        .segment-btn.active::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 2px;
            background: var(--color-primary);
            border-radius: 2px 2px 0 0;
        }

        .segment-btn-icon {
            font-size: 18px;
        }

        /* Hide sliding indicator - using underline instead */
        .segment-indicator {
            display: none;
        }

        /* ---- Tab Panels ---- */
        .tab-panel {
            display: none;
            padding: 0 var(--space-6) var(--space-6);
            animation: fadeIn var(--transition-base);
        }

        .tab-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ---- Section Cards - Simplified with less visual weight ---- */
        .section-card {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: var(--space-6) 0;
            margin-bottom: 0;
            border-bottom: 1px solid var(--color-separator);
        }

        .section-card:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            letter-spacing: var(--letter-spacing-tight);
            line-height: var(--line-height-snug);
            margin-bottom: var(--space-5);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .section-title-icon {
            font-size: 22px;
            color: var(--color-text-secondary);
        }

        /* ---- Form Elements - Refined Apple-style ---- */
        .form-group {
            margin-bottom: var(--space-5);
        }

        .form-label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            letter-spacing: var(--letter-spacing-wide);
            margin-bottom: var(--space-2);
        }

        .form-label-hint {
            font-weight: var(--font-weight-regular);
            color: var(--color-text-quaternary);
            margin-left: var(--space-2);
        }

        .form-input {
            width: 100%;
            min-height: 44px;
            padding: 0 var(--space-4);
            background: var(--color-bg-primary);
            border: 1px solid var(--color-separator-medium);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: var(--font-size-md);
            color: var(--color-text-primary);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .form-input:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px var(--color-primary-subtle);
            outline: none;
        }

        .form-input::placeholder {
            color: var(--color-text-quaternary);
            font-style: normal;
        }

        .form-input:disabled {
            background: var(--color-bg-secondary);
            color: var(--color-text-tertiary);
            border-color: var(--color-separator);
            cursor: not-allowed;
        }

        /* Input with icon */
        .input-with-icon {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
            pointer-events: none;
        }

        .input-with-icon .form-input {
            padding-left: 40px;
        }

        /* Form row (inline) */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        /* ---- Buttons - Refined Apple-style system ---- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            min-height: 44px;
            padding: 0 var(--space-5);
            border: none;
            border-radius: var(--radius-lg);
            font-family: inherit;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            letter-spacing: -0.01em;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            background: var(--color-bg-tertiary);
            color: var(--color-text-tertiary);
            border-color: transparent;
            cursor: not-allowed;
            opacity: 1;
        }

        /* Primary button - refined with subtle shadow */
        .btn-primary {
            background: var(--color-primary);
            color: var(--color-text-inverse);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-hover);
            box-shadow: var(--shadow-md), var(--shadow-primary);
        }

        .btn-primary:active:not(:disabled) {
            box-shadow: var(--shadow-xs);
        }

        /* Secondary button - with border */
        .btn-secondary {
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-separator-medium);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-bg-tertiary);
            border-color: var(--color-separator-strong);
        }

        /* Success button */
        .btn-success {
            background: var(--color-success);
            color: var(--color-text-inverse);
            box-shadow: var(--shadow-sm);
        }

        .btn-success:hover:not(:disabled) {
            background: var(--color-success-hover);
            box-shadow: var(--shadow-md);
        }

        /* Warning button */
        .btn-warning {
            background: var(--color-warning);
            color: var(--color-text-inverse);
            box-shadow: var(--shadow-sm);
        }

        .btn-warning:hover:not(:disabled) {
            background: var(--color-warning-hover);
            box-shadow: var(--shadow-md);
        }

        /* Danger button */
        .btn-danger {
            background: var(--color-danger);
            color: var(--color-text-inverse);
            box-shadow: var(--shadow-sm);
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--color-danger-hover);
            box-shadow: var(--shadow-md);
        }

        /* Purple button */
        .btn-purple {
            background: var(--color-purple);
            color: var(--color-text-inverse);
            box-shadow: var(--shadow-sm);
        }

        .btn-purple:hover:not(:disabled) {
            box-shadow: var(--shadow-md);
        }

        /* Ghost button - text only */
        .btn-ghost {
            background: transparent;
            color: var(--color-primary);
            padding: 0 var(--space-4);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--color-primary-subtle);
            transform: none;
        }

        /* Full width button */
        .btn-block {
            width: 100%;
        }

        /* Button group */
        .btn-group {
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        /* Button with loading spinner */
        .btn-loading {
            pointer-events: none;
        }

        .btn-loading .btn-text {
            opacity: 0;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border: 2px solid var(--color-primary-subtle);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ---- Status Messages - Subtle accent border style ---- */
        .status-message {
            display: none;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            line-height: var(--line-height-relaxed);
            margin-top: var(--space-5);
            animation: slideUp var(--transition-base);
            border-left: 3px solid;
            background: var(--color-bg-secondary);
        }

        .status-message.visible {
            display: flex;
        }

        .status-message.success {
            border-color: var(--color-success);
            background: rgba(40, 167, 69, 0.03);
        }

        .status-message.success .status-icon {
            color: var(--color-success);
        }

        .status-message.error {
            border-color: var(--color-danger);
            background: rgba(220, 53, 69, 0.03);
        }

        .status-message.error .status-icon {
            color: var(--color-danger);
        }

        .status-message.warning {
            border-color: var(--color-warning);
            background: rgba(255, 159, 10, 0.03);
        }

        .status-message.warning .status-icon {
            color: var(--color-warning);
        }

        .status-message.info {
            border-color: var(--color-primary);
            background: rgba(0, 113, 227, 0.03);
        }

        .status-message.info .status-icon {
            color: var(--color-primary);
        }

        .status-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .status-text {
            color: var(--color-text-primary);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ---- Image Grid ---- */
        .images-section {
            display: none;
        }

        .images-section.visible {
            display: block;
            animation: fadeIn var(--transition-base);
        }

        .images-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
            flex-wrap: wrap;
            gap: var(--space-3);
        }

        .images-count {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
        }

        .images-count-number {
            color: var(--color-primary);
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-4);
        }

        .image-card {
            background: var(--color-bg-primary);
            border: 1px solid var(--color-separator);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .image-card:hover {
            border-color: var(--color-separator-strong);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .image-card.selected {
            border-color: var(--color-primary);
            background: var(--color-bg-primary);
            box-shadow: 0 0 0 1px var(--color-primary), var(--shadow-sm);
        }

        /* Custom checkbox - Rounded Apple-style */
        .checkbox-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .checkbox-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .checkbox-custom {
            width: 22px;
            height: 22px;
            border: 2px solid var(--color-separator-strong);
            border-radius: 6px;
            background: var(--color-bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-spring);
            pointer-events: none;
        }

        .checkbox-input:checked + .checkbox-custom {
            background: var(--color-primary);
            border-color: var(--color-primary);
            transform: scale(1.05);
        }

        .checkbox-custom::after {
            content: '';
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2.5px 2.5px 0;
            transform: rotate(45deg) scale(0);
            transition: transform var(--transition-spring);
        }

        .checkbox-input:checked + .checkbox-custom::after {
            transform: rotate(45deg) scale(1);
        }

        .image-info {
            flex: 1;
            min-width: 0;
        }

        .image-filename {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            margin-bottom: var(--space-1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-meta {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .image-meta-item {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
        }

        .image-meta-item + .image-meta-item::before {
            content: '·';
            margin: 0 var(--space-2);
        }

        /* ---- Selection Summary ---- */
        .summary-section {
            display: none;
        }

        .summary-section.visible {
            display: block;
            animation: fadeIn var(--transition-base);
        }

        .summary-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-separator);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
        }

        .summary-pre {
            background: var(--color-bg-primary);
            border: 1px solid var(--color-separator);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: var(--font-size-sm);
            line-height: var(--line-height-relaxed);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* ---- Dual Connection Layout ---- */
        .dual-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-4);
        }

        .connection-box {
            background: var(--color-bg-primary);
            border: 1px solid var(--color-separator);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            position: relative;
        }

        /* Accent bar on the left */
        .connection-box::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            border-radius: var(--radius-xl) 0 0 var(--radius-xl);
        }

        .connection-box.source::before {
            background: var(--color-primary);
        }

        .connection-box.target::before {
            background: var(--color-warning);
        }

        .connection-box-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            letter-spacing: var(--letter-spacing-tight);
            margin-bottom: var(--space-5);
            text-align: center;
        }

        .connection-box.source .connection-box-title {
            color: var(--color-primary);
        }

        .connection-box.target .connection-box-title {
            color: var(--color-warning);
        }

        /* ---- Toggle Switch - Refined desktop size ---- */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            cursor: pointer;
        }

        .toggle-input {
            position: absolute;
            opacity: 0;
        }

        .toggle-slider {
            position: relative;
            width: 44px;
            height: 26px;
            background: var(--color-bg-tertiary);
            border-radius: 26px;
            transition: background var(--transition-base);
            flex-shrink: 0;
        }

        .toggle-input:checked + .toggle-slider {
            background: var(--color-success);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08);
            transition: transform var(--transition-base);
        }

        .toggle-input:checked + .toggle-slider::before {
            transform: translateX(18px);
        }

        .toggle-label {
            font-weight: var(--font-weight-medium);
        }

        /* ---- Expandable Panel ---- */
        .expandable-panel {
            background: var(--color-warning-light);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-top: var(--space-4);
            display: none;
        }

        .expandable-panel.visible {
            display: block;
            animation: fadeIn var(--transition-base);
        }

        /* ---- Statistics Cards - More prominent with hero numbers ---- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .stat-card {
            background: var(--color-bg-primary);
            border: 1px solid var(--color-separator);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            text-align: center;
            transition: all var(--transition-base);
        }

        .stat-card:hover {
            border-color: var(--color-separator-medium);
            box-shadow: var(--shadow-sm);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: var(--font-size-hero);
            font-weight: var(--font-weight-bold);
            line-height: var(--line-height-tight);
            letter-spacing: var(--letter-spacing-tight);
            margin-bottom: var(--space-2);
        }

        .stat-card.primary .stat-value { color: var(--color-primary); }
        .stat-card.success .stat-value { color: var(--color-success); }
        .stat-card.warning .stat-value { color: var(--color-warning); }
        .stat-card.danger .stat-value { color: var(--color-danger); }

        .stat-label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            letter-spacing: var(--letter-spacing-wide);
        }

        /* ---- Progress Bar ---- */
        .progress-wrapper {
            display: none;
            padding: var(--space-5);
            background: var(--color-primary-light);
            border-radius: var(--radius-lg);
            margin-top: var(--space-4);
        }

        .progress-wrapper.visible {
            display: block;
            animation: fadeIn var(--transition-base);
        }

        .progress-text {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--color-primary);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-3);
        }

        .progress-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--color-primary-light);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .progress-bar-track {
            height: 6px;
            background: var(--color-bg-primary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: var(--radius-full);
            transition: width var(--transition-slow);
            position: relative;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        /* ---- Slider (Range Input) ---- */
        .slider-wrapper {
            margin-bottom: var(--space-4);
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }

        .slider-value {
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        .slider-input {
            width: 100%;
            height: 6px;
            appearance: none;
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-full);
            outline: none;
        }

        .slider-input::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: transform var(--transition-fast);
        }

        .slider-input::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .slider-input::-webkit-slider-thumb:active {
            transform: scale(0.95);
        }

        .slider-hint {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: var(--space-2);
        }

        /* ---- Select Dropdown ---- */
        .select-wrapper {
            position: relative;
        }

        .form-select {
            width: 100%;
            height: 44px;
            padding: 0 var(--space-10) 0 var(--space-4);
            background: var(--color-bg-primary);
            border: 1px solid var(--color-separator);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
            appearance: none;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .form-select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px var(--color-primary-light);
        }

        .select-arrow {
            position: absolute;
            right: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--color-text-secondary);
        }

        /* ---- File Upload ---- */
        .file-upload {
            position: relative;
            border: 2px dashed var(--color-separator);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            text-align: center;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .file-upload.dragover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .file-upload-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload-icon {
            font-size: 48px;
            margin-bottom: var(--space-3);
        }

        .file-upload-text {
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-1);
        }

        .file-upload-hint {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        /* ---- Annotations Preview ---- */
        .preview-panel {
            display: none;
            margin-top: var(--space-6);
            border: 2px solid var(--color-separator);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .preview-panel.visible {
            display: block;
            animation: fadeIn var(--transition-base);
        }

        .preview-panel.source { border-color: var(--color-primary); }
        .preview-panel.target { border-color: var(--color-warning); }
        .preview-panel.match { border-color: var(--color-purple); }

        .preview-header {
            padding: var(--space-4) var(--space-5);
            background: var(--color-bg-secondary);
            font-weight: var(--font-weight-semibold);
        }

        .preview-panel.source .preview-header { color: var(--color-primary); }
        .preview-panel.target .preview-header { color: var(--color-warning); }
        .preview-panel.match .preview-header { color: var(--color-purple); }

        .preview-content {
            padding: var(--space-5);
            max-height: 400px;
            overflow-y: auto;
        }

        .preview-item {
            padding: var(--space-4);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-separator);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition-base);
        }

        .preview-item:hover {
            background: var(--color-bg-primary);
            box-shadow: var(--shadow-sm);
        }

        .preview-item-name {
            font-weight: var(--font-weight-medium);
        }

        .preview-item-meta {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .preview-item-count {
            display: flex;
            gap: var(--space-3);
            font-size: var(--font-size-sm);
        }

        /* ---- Recommendations Section ---- */
        .recommendations {
            background: var(--color-bg-primary);
            border: 1px solid var(--color-separator);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
        }

        .recommendations-title {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-5);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .recommendations-list {
            list-style: none;
        }

        .recommendations-list li {
            padding: var(--space-3) 0;
            padding-left: var(--space-5);
            position: relative;
            font-size: var(--font-size-base);
            color: var(--color-text-secondary);
            line-height: var(--line-height-relaxed);
        }

        .recommendations-list li::before {
            content: '•';
            position: absolute;
            left: var(--space-2);
            color: var(--color-primary);
            font-size: var(--font-size-lg);
        }

        .recommendations-list li strong {
            color: var(--color-text-primary);
            font-weight: var(--font-weight-semibold);
        }

        /* ---- Toast Notifications ---- */
        .toast-container {
            position: fixed;
            top: var(--space-6);
            right: var(--space-6);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .toast {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-5);
            background: rgba(29, 29, 31, 0.95);
            color: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            transform: translateX(120%);
            transition: transform var(--transition-slow);
            min-width: 280px;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .toast.visible {
            transform: translateX(0);
        }

        .toast-icon {
            font-size: 18px;
        }

        .toast-message {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-regular);
            line-height: var(--line-height-normal);
        }

        /* ---- Empty State ---- */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-12) var(--space-6);
            text-align: center;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            background: var(--color-bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: var(--space-5);
        }

        .empty-state-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-2);
        }

        .empty-state-description {
            color: var(--color-text-secondary);
            max-width: 400px;
            margin-bottom: var(--space-6);
        }

        /* ---- Job Summary ---- */
        .job-summary {
            display: none;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-separator);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-top: var(--space-5);
        }

        .job-summary.visible {
            display: block;
            animation: fadeIn var(--transition-base);
        }

        .job-summary-title {
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-4);
        }

        .job-summary-item {
            font-size: var(--font-size-sm);
            padding: var(--space-2) 0;
            display: flex;
            justify-content: space-between;
        }

        .job-summary-item.error {
            color: var(--color-danger);
        }

        /* ---- Duplicate Summary ---- */
        .duplicate-summary {
            display: none;
            background: var(--color-success-light);
            border: 1px solid rgba(52, 199, 89, 0.2);
            border-left: 3px solid var(--color-success);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-top: var(--space-4);
        }

        .duplicate-summary.visible {
            display: block;
            animation: fadeIn var(--transition-base);
        }

        .duplicate-summary-title {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-md);
            color: #1B7F37;
            margin-bottom: var(--space-3);
        }

        /* ---- Responsive Adjustments ---- */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: var(--space-3);
                text-align: center;
            }

            .segmented-control {
                flex-direction: column;
            }

            .segment-indicator {
                display: none;
            }

            .segment-btn.active {
                background: var(--color-bg-primary);
                box-shadow: var(--shadow-sm);
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                width: 100%;
            }

            .images-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ---- Print Styles ---- */
        @media print {
            .app-header,
            .segmented-control,
            .btn-group,
            .toast-container {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer" aria-live="polite"></div>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="app-logo">
                <div class="app-logo-icon" aria-hidden="true">C</div>
                <span class="app-logo-text">CVAT Labeling Tools</span>
            </div>
            <div class="app-status disconnected" id="connectionStatus">
                <span class="status-indicator"></span>
                <span id="connectionText">Not Connected</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-card" id="main-content">
            <!-- Segmented Control (Tabs) -->
            <nav class="segmented-control" role="tablist" aria-label="Main navigation">
                <button class="segment-btn active" role="tab" aria-selected="true" aria-controls="selector-panel" id="selector-tab" onclick="switchTab('selector')">
                    <span>Image Selector</span>
                </button>
                <button class="segment-btn" role="tab" aria-selected="false" aria-controls="copier-panel" id="copier-tab" onclick="switchTab('copier')">
                    <span>Annotation Copier</span>
                </button>
                <button class="segment-btn" role="tab" aria-selected="false" aria-controls="video-panel" id="video-tab" onclick="switchTab('video')">
                    <span>Video Analyzer</span>
                </button>
                <div class="segment-indicator" aria-hidden="true"></div>
            </nav>

            <!-- Tab Panel: Image Selector -->
            <div class="tab-panel active" id="selector-panel" role="tabpanel" aria-labelledby="selector-tab">
                <!-- Connection Section -->
                <section class="section-card">
                    <h2 class="section-title">
                        CVAT Connection
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="cvatUrl">Server URL</label>
                            <input type="url" id="cvatUrl" class="form-input" value="{{ cvat_url or 'http://localhost:8080' }}" placeholder="https://cvat.example.com" autocomplete="url">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="username">Username</label>
                            <input type="text" id="username" class="form-input" value="{{ cvat_username }}" placeholder="your_username" autocomplete="username">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="password">Password</label>
                            <input type="password" id="password" class="form-input" placeholder="••••••••" autocomplete="current-password">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="testConnection()" id="connectBtn">
                        <span class="btn-text">Connect to CVAT</span>
                    </button>

                    <div class="status-message" id="connectionStatusMsg" role="alert"></div>
                </section>

                <!-- Load Images Section -->
                <section class="section-card">
                    <h2 class="section-title">
                        Load Images
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="taskId">Task ID <span class="form-label-hint">(required)</span></label>
                            <input type="number" id="taskId" class="form-input" placeholder="Enter task ID" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="jobId">Job ID <span class="form-label-hint">(optional)</span></label>
                            <input type="number" id="jobId" class="form-input" placeholder="Leave empty for entire task" min="1">
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="loadImages()" id="loadBtn">
                        <span class="btn-text">Load All Images</span>
                    </button>

                    <div class="status-message" id="loadStatusMsg" role="alert"></div>
                </section>

                <!-- Random Selection Section -->
                <section class="section-card">
                    <h2 class="section-title">
                        Random Selection
                    </h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="randomCount">Images per Job</label>
                            <input type="number" id="randomCount" class="form-input" value="10" min="1" max="1000">
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-purple" onclick="randomSelect()" id="randomSelectBtn">
                            <span class="btn-text">Select Random Images</span>
                        </button>
                        <button class="btn btn-secondary" onclick="debugLocalTask()">
                            Debug Task
                        </button>
                    </div>

                    <!-- Duplicate Check Toggle -->
                    <div style="margin-top: var(--space-5);">
                        <label class="toggle-wrapper">
                            <input type="checkbox" class="toggle-input" id="enableDuplicateCheck" onchange="toggleDuplicateCheckOptions()">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Check for duplicates in another CVAT instance</span>
                        </label>
                    </div>

                    <!-- Duplicate Check Options (expandable) -->
                    <div class="expandable-panel" id="duplicateCheckOptions">
                        <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">
                            Connect to another CVAT instance to exclude images that already exist there.
                        </p>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="checkCvatUrl">CVAT URL to check</label>
                                <input type="url" id="checkCvatUrl" class="form-input" placeholder="http://other-cvat.com:8080">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="checkUsername">Username</label>
                                <input type="text" id="checkUsername" class="form-input" placeholder="username">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="checkPassword">Password</label>
                                <input type="password" id="checkPassword" class="form-input" placeholder="password">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="checkTaskId">Task ID to check against</label>
                                <input type="number" id="checkTaskId" class="form-input" placeholder="Task ID" min="1">
                            </div>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-warning" onclick="testDuplicateCheckConnection()">
                                Test Connection
                            </button>
                            <button class="btn btn-secondary" onclick="debugRemoteTask()">
                                Debug Remote Task
                            </button>
                        </div>

                        <div class="status-message" id="duplicateCheckConnectionStatus" role="alert"></div>
                    </div>

                    <div class="status-message" id="randomStatusMsg" role="alert"></div>

                    <div class="job-summary" id="jobSummary">
                        <h3 class="job-summary-title">Selection Summary by Job</h3>
                        <div id="jobSummaryContent"></div>
                    </div>

                    <div class="duplicate-summary" id="duplicateSummary">
                        <h3 class="duplicate-summary-title">Duplicate Check Results</h3>
                        <div id="duplicateSummaryContent"></div>
                    </div>
                </section>

                <!-- Images Display Section -->
                <section class="section-card images-section" id="imagesSection">
                    <div class="images-header">
                        <h2 class="images-count">
                            Available Images (<span class="images-count-number" id="imageCount">0</span>)
                        </h2>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="selectAll()" id="selectAllBtn">Select All</button>
                            <button class="btn btn-danger" onclick="clearSelection()" id="clearSelectionBtn">Clear Selection</button>
                            <button class="btn btn-secondary" onclick="getSelection()">Get Selected Info</button>
                            <button class="btn btn-warning" onclick="downloadImages()" id="downloadBtn">Download as ZIP</button>
                        </div>
                    </div>
                    <div class="images-grid" id="imagesGrid" role="list">
                        <!-- Images will be loaded here -->
                    </div>
                </section>

                <!-- Selection Summary Section -->
                <section class="section-card summary-section" id="summarySection">
                    <h2 class="section-title">
                        Selection Summary
                    </h2>
                    <div class="summary-card">
                        <h3 style="margin-bottom: var(--space-3);">Selected: <span id="selectedCount">0</span> images</h3>
                        <pre class="summary-pre" id="summaryContent"></pre>
                    </div>
                </section>
            </div>

            <!-- Tab Panel: Annotation Copier -->
            <div class="tab-panel" id="copier-panel" role="tabpanel" aria-labelledby="copier-tab">
                <!-- Dual Connection Section -->
                <section class="section-card">
                    <h2 class="section-title">
                        Connect to CVAT Instances
                    </h2>

                    <div class="dual-layout">
                        <!-- Source CVAT -->
                        <div class="connection-box source">
                            <h3 class="connection-box-title">Source CVAT (with annotations)</h3>
                            <div class="form-group">
                                <label class="form-label" for="sourceUrl">CVAT URL</label>
                                <input type="url" id="sourceUrl" class="form-input" value="{{ cvat_url or 'http://localhost:8080' }}" placeholder="http://source-cvat.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="sourceUsername">Username</label>
                                <input type="text" id="sourceUsername" class="form-input" value="{{ cvat_username }}" placeholder="username">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="sourcePassword">Password</label>
                                <input type="password" id="sourcePassword" class="form-input" placeholder="password">
                            </div>
                        </div>

                        <!-- Target CVAT -->
                        <div class="connection-box target">
                            <h3 class="connection-box-title">Target CVAT (without annotations)</h3>
                            <div class="form-group">
                                <label class="form-label" for="targetUrl">CVAT URL</label>
                                <input type="url" id="targetUrl" class="form-input" placeholder="http://target-cvat.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="targetUsername">Username</label>
                                <input type="text" id="targetUsername" class="form-input" placeholder="username">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="targetPassword">Password</label>
                                <input type="password" id="targetPassword" class="form-input" placeholder="password">
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-block" onclick="testDualConnection()" style="margin-top: var(--space-4);">
                        Connect to Both Instances
                    </button>

                    <div class="status-message" id="dualConnectionStatus" role="alert"></div>
                </section>

                <!-- Copy Annotations Section -->
                <section class="section-card">
                    <h2 class="section-title">
                        Copy Annotations
                    </h2>

                    <div class="dual-layout">
                        <!-- Source Task/Job -->
                        <div class="connection-box source">
                            <h3 class="connection-box-title">Source</h3>
                            <div class="form-group">
                                <label class="form-label" for="sourceTaskId">Task ID <span class="form-label-hint">(required)</span></label>
                                <input type="number" id="sourceTaskId" class="form-input" placeholder="Enter source task ID" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="sourceJobId">Job ID <span class="form-label-hint">(optional)</span></label>
                                <input type="number" id="sourceJobId" class="form-input" placeholder="Leave empty for task-level" min="1">
                            </div>
                            <button class="btn btn-primary btn-block" onclick="previewAnnotations()">
                                Preview Annotations
                            </button>
                        </div>

                        <!-- Target Task/Job -->
                        <div class="connection-box target">
                            <h3 class="connection-box-title">Target</h3>
                            <div class="form-group">
                                <label class="form-label" for="targetTaskId">Task ID <span class="form-label-hint">(required)</span></label>
                                <input type="number" id="targetTaskId" class="form-input" placeholder="Enter target task ID" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="targetJobId">Job ID <span class="form-label-hint">(optional)</span></label>
                                <input type="number" id="targetJobId" class="form-input" placeholder="Leave empty for task-level" min="1">
                            </div>
                            <button class="btn btn-warning btn-block" onclick="previewTargetAnnotations()">
                                Preview Target
                            </button>
                        </div>
                    </div>

                    <div class="btn-group" style="margin-top: var(--space-5);">
                        <button class="btn btn-purple" onclick="previewMatches()">
                            Preview Filename Matches
                        </button>
                        <button class="btn btn-primary" onclick="copyAnnotations()">
                            Copy Annotations
                        </button>
                    </div>

                    <div class="status-message warning" style="display: flex; margin-top: var(--space-4);">
                        <div>
                            <strong>Important:</strong><br>
                            • If Job IDs are provided, annotations will be copied at the job level<br>
                            • If Job IDs are empty, annotations will be copied at the task level<br>
                            • Both source and target must be at the same level (both job or both task)<br>
                            • The target task/job should have the same structure as the source
                        </div>
                    </div>

                    <div class="status-message" id="copyStatus" role="alert"></div>

                    <!-- Annotation Previews -->
                    <div class="preview-panel source" id="annotationPreview">
                        <div class="preview-header">Source Annotation Preview</div>
                        <div class="stats-grid" id="previewSummary" style="padding: var(--space-5);"></div>
                        <div class="preview-content" id="previewFiles"></div>
                    </div>

                    <div class="preview-panel target" id="targetAnnotationPreview">
                        <div class="preview-header">Target Annotation Preview</div>
                        <div class="stats-grid" id="targetPreviewSummary" style="padding: var(--space-5);"></div>
                        <div class="preview-content" id="targetPreviewFiles"></div>
                    </div>

                    <div class="preview-panel match" id="matchPreview">
                        <div class="preview-header">Filename Match Preview</div>
                        <div class="stats-grid" id="matchSummary" style="padding: var(--space-5);"></div>
                        <div class="preview-content" id="matchDetails"></div>
                    </div>
                </section>
            </div>

            <!-- Tab Panel: Video Analyzer -->
            <div class="tab-panel" id="video-panel" role="tabpanel" aria-labelledby="video-tab">
                <!-- Video Upload Section -->
                <section class="section-card">
                    <h2 class="section-title">
                        Video Frame Analysis & Selection
                    </h2>

                    <p style="color: var(--color-text-secondary); margin-bottom: var(--space-5);">
                        Upload a video file to automatically detect scene changes and remove static frames with no movement.
                    </p>

                    <!-- File Upload -->
                    <div class="file-upload" id="videoDropZone">
                        <input type="file" class="file-upload-input" id="videoFile" accept=".mp4,.avi,.mov,.svo,.mkv">
                        <div class="file-upload-icon" aria-hidden="true"></div>
                        <div class="file-upload-text">Drop your video here or click to browse</div>
                        <div class="file-upload-hint">Supports MP4, AVI, MOV, SVO, MKV (max 500MB)</div>
                    </div>

                    <!-- Analysis Options -->
                    <div style="margin-top: var(--space-6);">
                        <div class="form-group">
                            <label class="form-label" for="detectionMethod">Scene Detection Method</label>
                            <div class="select-wrapper">
                                <select id="detectionMethod" class="form-select">
                                    <option value="adaptive">Adaptive Threshold (Recommended)</option>
                                    <option value="histogram">Histogram Comparison</option>
                                </select>
                                <span class="select-arrow" aria-hidden="true">▼</span>
                            </div>
                        </div>

                        <div class="slider-wrapper">
                            <div class="slider-header">
                                <label class="form-label" for="sceneThreshold">Scene Change Sensitivity</label>
                                <span class="slider-value" id="sceneThresholdValue">30%</span>
                            </div>
                            <input type="range" class="slider-input" id="sceneThreshold" min="10" max="80" value="30" oninput="document.getElementById('sceneThresholdValue').textContent=this.value+'%'">
                            <div class="slider-hint">Lower = More sensitive, Higher = Less sensitive</div>
                        </div>

                        <div class="slider-wrapper">
                            <div class="slider-header">
                                <label class="form-label" for="motionThreshold">Motion Detection Sensitivity</label>
                                <span class="slider-value" id="motionThresholdValue">2.0</span>
                            </div>
                            <input type="range" class="slider-input" id="motionThreshold" min="0.5" max="10.0" value="2.0" step="0.5" oninput="document.getElementById('motionThresholdValue').textContent=this.value">
                            <div class="slider-hint">Threshold for detecting movement between frames</div>
                        </div>

                        <div class="slider-wrapper">
                            <div class="slider-header">
                                <label class="form-label" for="minSceneLength">Minimum Scene Length (frames)</label>
                                <span class="slider-value" id="minSceneLengthValue">15</span>
                            </div>
                            <input type="range" class="slider-input" id="minSceneLength" min="5" max="60" value="15" oninput="document.getElementById('minSceneLengthValue').textContent=this.value">
                            <div class="slider-hint">Prevents detecting very short scene changes</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="targetFps">Target FPS for Analysis <span class="form-label-hint">(optional)</span></label>
                            <input type="number" id="targetFps" class="form-input" min="0.1" max="60" step="0.1" placeholder="Leave empty to use original FPS">
                        </div>
                    </div>

                    <button class="btn btn-primary btn-block" onclick="analyzeVideo()" id="analyzeBtn" style="margin-top: var(--space-4);">
                        Analyze Video
                    </button>

                    <div class="progress-wrapper" id="videoAnalysisProgress">
                        <div class="progress-text">
                            <span class="progress-spinner"></span>
                            <span>Analyzing video... This may take a few moments.</span>
                        </div>
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill" id="analysisProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </section>

                <!-- Analysis Results Section -->
                <section class="section-card" id="videoResultsSection" style="display: none;">
                    <h2 class="section-title">
                        Analysis Results
                    </h2>

                    <div id="videoInfoDisplay" style="background: var(--color-bg-primary); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-5);"></div>

                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="stat-value" id="sceneCountDisplay">0</div>
                            <div class="stat-label">Scene Changes Detected</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-value" id="motionFramesDisplay">0</div>
                            <div class="stat-label">Frames with Motion</div>
                        </div>
                        <div class="stat-card danger">
                            <div class="stat-value" id="staticFramesDisplay">0</div>
                            <div class="stat-label">Static Frames</div>
                        </div>
                    </div>

                    <!-- Filter Options -->
                    <div class="form-group">
                        <label class="form-label" for="filterMode">Frame Selection Strategy</label>
                        <div class="select-wrapper">
                            <select id="filterMode" class="form-select">
                                <option value="scenes">Scene Changes Only</option>
                                <option value="motion" selected>Frames with Motion Only</option>
                                <option value="both">Scene Changes OR Motion (Union)</option>
                            </select>
                            <span class="select-arrow" aria-hidden="true">▼</span>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-block" onclick="applyFrameFilter()">
                        Apply Filter & Select Frames
                    </button>

                    <div id="filterResultsDisplay" style="display: none; margin-top: var(--space-5);">
                        <div style="background: var(--color-primary-light); padding: var(--space-5); border-radius: var(--radius-lg);">
                            <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-primary); margin-bottom: var(--space-3);">
                                Selected <span id="selectedFrameCount">0</span> frames
                            </div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                Static frames removed: <span id="removedFrameCount">0</span>
                            </div>
                            <button class="btn btn-success btn-block" onclick="downloadSelectedFrames()" id="downloadFramesBtn" style="margin-top: var(--space-4);">
                                Download Selected Frames as ZIP
                            </button>
                        </div>

                        <div class="status-message warning visible" style="margin-top: var(--space-4);">
                            <div id="frameSummary"></div>
                        </div>

                        <div style="margin-top: var(--space-4); max-height: 300px; overflow-y: auto; background: var(--color-bg-secondary); padding: var(--space-4); border-radius: var(--radius-md);">
                            <div style="font-weight: var(--font-weight-semibold); margin-bottom: var(--space-3);">Selected Frame Indices:</div>
                            <div id="selectedFrameList" style="font-size: var(--font-size-sm); line-height: var(--line-height-relaxed);"></div>
                        </div>
                    </div>
                </section>

                <!-- Recommendations -->
                <section class="recommendations">
                    <h2 class="recommendations-title">
                        <span aria-hidden="true">💡</span>
                        Recommendations & Tips
                    </h2>
                    <ul class="recommendations-list">
                        <li><strong>Scene Detection:</strong> Use when you want to identify major transitions (camera cuts, location changes)</li>
                        <li><strong>Motion Detection:</strong> Use to remove static frames where nothing is happening</li>
                        <li><strong>Adaptive Method:</strong> Works well with most video types and lighting conditions</li>
                        <li><strong>Histogram Method:</strong> Better for videos with consistent lighting but different content</li>
                        <li><strong>Sensitivity Tuning:</strong> Start with default values, then adjust based on your video</li>
                        <li><strong>Min Scene Length:</strong> Increase if you're getting too many false scene detections</li>
                    </ul>
                </section>
            </div>
        </main>
    </div>

    <script>
        // ============================================================================
        // CVAT Labeling Tools - JavaScript Application
        // ============================================================================

        // ---- State Management ----
        let currentImages = [];
        let connected = false;
        let videoAnalysisData = null;
        let currentSelectedFrames = [];

        // ---- Keyboard Navigation Detection ----
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Tab') {
                document.body.classList.add('keyboard-nav');
            }
        });

        document.addEventListener('mousedown', () => {
            document.body.classList.remove('keyboard-nav');
        });

        // ---- Tab Switching with Animation ----
        function switchTab(tabName) {
            // Update segment buttons
            document.querySelectorAll('.segment-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });

            // Update tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Activate selected tab
            const activeBtn = document.getElementById(`${tabName}-tab`);
            const activePanel = document.getElementById(`${tabName}-panel`);

            if (activeBtn && activePanel) {
                activeBtn.classList.add('active');
                activeBtn.setAttribute('aria-selected', 'true');
                activePanel.classList.add('active');
            }

            // Animate indicator
            updateIndicator();
        }

        function updateIndicator() {
            const activeBtn = document.querySelector('.segment-btn.active');
            const indicator = document.querySelector('.segment-indicator');

            if (activeBtn && indicator) {
                const btnRect = activeBtn.getBoundingClientRect();
                const containerRect = activeBtn.parentElement.getBoundingClientRect();

                indicator.style.width = `${btnRect.width}px`;
                indicator.style.transform = `translateX(${btnRect.left - containerRect.left - 3}px)`;
            }
        }

        // Initialize indicator on load
        window.addEventListener('load', updateIndicator);
        window.addEventListener('resize', updateIndicator);

        // ---- Toast Notifications ----
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <span class="toast-message">${message}</span>
            `;

            container.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('visible');
            });

            // Remove after delay
            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ---- Status Message Helper ----
        function showStatus(elementId, message, type) {
            const statusDiv = document.getElementById(elementId);
            if (!statusDiv) return;

            statusDiv.className = `status-message ${type} visible`;
            statusDiv.innerHTML = `
                <span>${message}</span>
            `;
        }

        // ---- Connection Status Update ----
        function updateConnectionStatus(isConnected, text) {
            const status = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');

            if (isConnected) {
                status.classList.remove('disconnected');
                statusText.textContent = text || 'Connected';
            } else {
                status.classList.add('disconnected');
                statusText.textContent = text || 'Not Connected';
            }
        }

        // ---- API Functions ----
        async function testConnection() {
            const url = document.getElementById('cvatUrl').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!url || !username || !password) {
                showStatus('connectionStatusMsg', 'Please fill in all connection fields', 'error');
                return;
            }

            const btn = document.getElementById('connectBtn');
            btn.classList.add('btn-loading');

            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, username, password })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus('connectionStatusMsg', data.message, 'success');
                    updateConnectionStatus(true, `Connected to ${new URL(url).hostname}`);
                    connected = true;
                    showToast('Connected to CVAT successfully!', 'success');
                } else {
                    showStatus('connectionStatusMsg', data.message, 'error');
                    updateConnectionStatus(false);
                    connected = false;
                }
            } catch (error) {
                showStatus('connectionStatusMsg', 'Connection error: ' + error.message, 'error');
                updateConnectionStatus(false);
                connected = false;
            } finally {
                btn.classList.remove('btn-loading');
            }
        }

        async function loadImages() {
            const taskId = document.getElementById('taskId').value;
            const jobId = document.getElementById('jobId').value;

            if (!taskId) {
                showStatus('loadStatusMsg', 'Please enter a Task ID', 'error');
                return;
            }

            const btn = document.getElementById('loadBtn');
            btn.classList.add('btn-loading');

            const sourceText = jobId ? `from job ${jobId}` : `from entire task ${taskId}`;
            showStatus('loadStatusMsg', `Loading images ${sourceText}...`, 'info');

            try {
                const response = await fetch('/api/load-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: taskId, job_id: jobId || null })
                });

                const data = await response.json();

                if (data.success) {
                    currentImages = data.images;
                    displayImages(currentImages);
                    showStatus('loadStatusMsg', `Loaded ${data.count} images from ${data.source}`, 'success');
                    document.getElementById('imagesSection').classList.add('visible');
                    showToast(`${data.count} images loaded`, 'success');
                } else {
                    showStatus('loadStatusMsg', data.message, 'error');
                }
            } catch (error) {
                showStatus('loadStatusMsg', 'Error loading images: ' + error.message, 'error');
            } finally {
                btn.classList.remove('btn-loading');
            }
        }

        function displayImages(images) {
            const grid = document.getElementById('imagesGrid');
            grid.innerHTML = '';
            document.getElementById('imageCount').textContent = images.length;

            if (images.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3 class="empty-state-title">No Images Found</h3>
                        <p class="empty-state-description">No images were found for the selected task or job.</p>
                    </div>
                `;
                return;
            }

            images.forEach((img, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.setAttribute('role', 'listitem');
                card.onclick = () => toggleImageSelection(index);

                const filename = img.filename || `frame_${img.frame}`;
                const jobIdText = img.job_id ? img.job_id : 'N/A';

                card.innerHTML = `
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="checkbox-input" id="img-${index}"
                               data-frame="${img.frame}"
                               data-task-id="${img.task_id}"
                               data-job-id="${img.job_id || ''}"
                               data-filename="${filename}">
                        <div class="checkbox-custom"></div>
                    </div>
                    <div class="image-info">
                        <div class="image-filename">${filename}</div>
                        <div class="image-meta">
                            <span class="image-meta-item">Frame ${img.frame}</span>
                            <span class="image-meta-item">Job ${jobIdText}</span>
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function toggleImageSelection(index) {
            const checkbox = document.getElementById(`img-${index}`);
            const card = checkbox.closest('.image-card');

            checkbox.checked = !checkbox.checked;
            card.classList.toggle('selected', checkbox.checked);
        }

        function selectAll() {
            document.querySelectorAll('#imagesGrid input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
                cb.closest('.image-card').classList.add('selected');
            });
            showToast('All images selected', 'info');
        }

        function clearSelection() {
            document.querySelectorAll('#imagesGrid input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.closest('.image-card').classList.remove('selected');
            });
            showToast('Selection cleared', 'info');
        }

        function getSelection() {
            const checkboxes = document.querySelectorAll('#imagesGrid input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => ({
                frame: parseInt(cb.dataset.frame),
                task_id: cb.dataset.taskId,
                job_id: cb.dataset.jobId || null,
                filename: cb.dataset.filename
            }));

            document.getElementById('selectedCount').textContent = selected.length;
            document.getElementById('summaryContent').textContent = JSON.stringify(selected, null, 2);
            document.getElementById('summarySection').classList.add('visible');
            document.getElementById('summarySection').scrollIntoView({ behavior: 'smooth' });
        }

        async function randomSelect() {
            const taskId = document.getElementById('taskId').value;
            const jobId = document.getElementById('jobId').value;
            const count = parseInt(document.getElementById('randomCount').value);

            if (!taskId) {
                showStatus('randomStatusMsg', 'Please enter Task ID first', 'error');
                return;
            }

            if (!count || count < 1) {
                showStatus('randomStatusMsg', 'Please enter a valid number of images', 'error');
                return;
            }

            const btn = document.getElementById('randomSelectBtn');
            btn.classList.add('btn-loading');

            const enableDuplicateCheck = document.getElementById('enableDuplicateCheck').checked;
            let duplicateCheckParams = null;

            if (enableDuplicateCheck) {
                const checkCvatUrl = document.getElementById('checkCvatUrl').value;
                const checkUsername = document.getElementById('checkUsername').value;
                const checkPassword = document.getElementById('checkPassword').value;
                const checkTaskId = document.getElementById('checkTaskId').value;

                if (!checkCvatUrl || !checkUsername || !checkPassword || !checkTaskId) {
                    showStatus('randomStatusMsg', 'Please fill in all duplicate check fields', 'error');
                    btn.classList.remove('btn-loading');
                    return;
                }

                duplicateCheckParams = {
                    check_url: checkCvatUrl,
                    check_username: checkUsername,
                    check_password: checkPassword,
                    check_task_id: checkTaskId
                };
            }

            try {
                const requestBody = {
                    task_id: taskId,
                    job_id: jobId || null,
                    count: count
                };

                if (duplicateCheckParams) {
                    requestBody.duplicate_check = duplicateCheckParams;
                }

                const response = await fetch('/api/random-select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.success) {
                    currentImages = data.images;
                    displayImages(currentImages);
                    selectAll();

                    if (data.job_summary && data.job_summary.length > 0) {
                        displayJobSummary(data.job_summary, data.per_job_count);
                        showStatus('randomStatusMsg', `Selected ${data.count} total images (${data.per_job_count} per job from ${data.jobs_count} jobs)`, 'success');
                    } else {
                        document.getElementById('jobSummary').classList.remove('visible');
                        showStatus('randomStatusMsg', `Selected ${data.count} random images from ${data.source}`, 'success');
                    }

                    if (data.duplicate_check_summary) {
                        displayDuplicateSummary(data.duplicate_check_summary);
                    } else {
                        document.getElementById('duplicateSummary').classList.remove('visible');
                    }

                    document.getElementById('imagesSection').classList.add('visible');
                    showToast(`${data.count} images selected`, 'success');
                } else {
                    showStatus('randomStatusMsg', data.message, 'error');
                }
            } catch (error) {
                showStatus('randomStatusMsg', 'Error selecting random images: ' + error.message, 'error');
            } finally {
                btn.classList.remove('btn-loading');
            }
        }

        function toggleDuplicateCheckOptions() {
            const checkbox = document.getElementById('enableDuplicateCheck');
            const options = document.getElementById('duplicateCheckOptions');
            options.classList.toggle('visible', checkbox.checked);
        }

        function displayJobSummary(summary, perJobCount) {
            const summaryDiv = document.getElementById('jobSummaryContent');
            summaryDiv.innerHTML = summary.map(job => {
                if (job.error) {
                    return `<div class="job-summary-item error"><strong>Job ${job.job_id}:</strong> Error: ${job.error}</div>`;
                }

                const duplicatesInfo = job.duplicates_skipped ? ` (${job.duplicates_skipped} duplicates skipped)` : '';
                const shortfall = job.requested ? job.requested - job.selected : perJobCount - job.selected;
                const shortfallInfo = shortfall > 0 ? ` (${shortfall} short)` : '';

                return `<div class="job-summary-item"><strong>Job ${job.job_id}:</strong> ${job.selected}/${job.total} images${duplicatesInfo}${shortfallInfo}</div>`;
            }).join('');

            document.getElementById('jobSummary').classList.add('visible');
        }

        function displayDuplicateSummary(summary) {
            const summaryDiv = document.getElementById('duplicateSummaryContent');
            summaryDiv.innerHTML = `
                <div style="font-size: var(--font-size-sm);">
                    <div><strong>Total candidates:</strong> ${summary.total_candidates}</div>
                    <div><strong>Requested per job:</strong> ${summary.requested_count || summary.requested_per_job || 'N/A'}</div>
                    <div><strong>Duplicates skipped:</strong> ${summary.duplicates_skipped || summary.duplicates_found || 0}</div>
                    <div><strong>Unique images selected:</strong> ${summary.unique_selected}</div>
                </div>
            `;
            document.getElementById('duplicateSummary').classList.add('visible');
        }

        async function downloadImages() {
            const checkboxes = document.querySelectorAll('#imagesGrid input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => ({
                frame: parseInt(cb.dataset.frame),
                task_id: cb.dataset.taskId,
                job_id: cb.dataset.jobId || null,
                filename: cb.dataset.filename
            }));

            if (selected.length === 0) {
                showToast('No images selected', 'warning');
                return;
            }

            const btn = document.getElementById('downloadBtn');
            btn.classList.add('btn-loading');
            showToast(`Downloading ${selected.length} images...`, 'info');

            try {
                const response = await fetch('/api/download-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frames: selected })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cvat_images_${Date.now()}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showToast(`Downloaded ${selected.length} images!`, 'success');
                } else {
                    const data = await response.json();
                    showToast('Download failed: ' + data.message, 'error');
                }
            } catch (error) {
                showToast('Error downloading images: ' + error.message, 'error');
            } finally {
                btn.classList.remove('btn-loading');
            }
        }

        async function debugLocalTask() {
            const taskId = document.getElementById('taskId').value;
            if (!taskId) {
                showStatus('randomStatusMsg', 'Please enter a Task ID first', 'error');
                return;
            }

            showStatus('randomStatusMsg', 'Debugging local task... Check server console', 'info');

            try {
                const response = await fetch('/api/debug-local-task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: taskId })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('=== LOCAL TASK DEBUG INFO ===', data);
                    showStatus('randomStatusMsg', `Task "${data.task_info.name}" - ${data.jobs_count} jobs, ${data.total_frames} frames. Check console!`, 'success');
                } else {
                    showStatus('randomStatusMsg', 'Debug failed: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('randomStatusMsg', 'Error: ' + error.message, 'error');
            }
        }

        async function debugRemoteTask() {
            const checkCvatUrl = document.getElementById('checkCvatUrl').value;
            const checkUsername = document.getElementById('checkUsername').value;
            const checkPassword = document.getElementById('checkPassword').value;
            const checkTaskId = document.getElementById('checkTaskId').value;

            if (!checkCvatUrl || !checkUsername || !checkPassword || !checkTaskId) {
                showStatus('duplicateCheckConnectionStatus', 'Please fill in all fields', 'error');
                return;
            }

            showStatus('duplicateCheckConnectionStatus', 'Debugging remote task...', 'info');

            try {
                const response = await fetch('/api/debug-remote-task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: checkCvatUrl,
                        username: checkUsername,
                        password: checkPassword,
                        task_id: checkTaskId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    console.log('=== REMOTE TASK DEBUG INFO ===', data);
                    showStatus('duplicateCheckConnectionStatus', `Task "${data.task_info.name}" - ${data.jobs_count} jobs, ${data.total_frames} frames`, 'success');
                } else {
                    showStatus('duplicateCheckConnectionStatus', data.message, 'error');
                }
            } catch (error) {
                showStatus('duplicateCheckConnectionStatus', 'Error: ' + error.message, 'error');
            }
        }

        async function testDuplicateCheckConnection() {
            const checkCvatUrl = document.getElementById('checkCvatUrl').value;
            const checkUsername = document.getElementById('checkUsername').value;
            const checkPassword = document.getElementById('checkPassword').value;

            if (!checkCvatUrl || !checkUsername || !checkPassword) {
                showStatus('duplicateCheckConnectionStatus', 'Please fill in URL, username and password', 'error');
                return;
            }

            showStatus('duplicateCheckConnectionStatus', 'Testing connection...', 'info');

            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: checkCvatUrl,
                        username: checkUsername,
                        password: checkPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus('duplicateCheckConnectionStatus', data.message, 'success');
                } else {
                    showStatus('duplicateCheckConnectionStatus', data.message, 'error');
                }
            } catch (error) {
                showStatus('duplicateCheckConnectionStatus', 'Error: ' + error.message, 'error');
            }
        }

        // ---- Annotation Copier Functions ----
        async function testDualConnection() {
            const sourceUrl = document.getElementById('sourceUrl').value;
            const sourceUsername = document.getElementById('sourceUsername').value;
            const sourcePassword = document.getElementById('sourcePassword').value;
            const targetUrl = document.getElementById('targetUrl').value;
            const targetUsername = document.getElementById('targetUsername').value;
            const targetPassword = document.getElementById('targetPassword').value;

            if (!sourceUrl || !sourceUsername || !sourcePassword || !targetUrl || !targetUsername || !targetPassword) {
                showStatus('dualConnectionStatus', 'Please fill in all connection fields', 'error');
                return;
            }

            showStatus('dualConnectionStatus', 'Testing connections...', 'info');

            try {
                const response = await fetch('/api/test-connection-dual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_url: sourceUrl,
                        source_username: sourceUsername,
                        source_password: sourcePassword,
                        target_url: targetUrl,
                        target_username: targetUsername,
                        target_password: targetPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus('dualConnectionStatus', `Source: ${data.source.message} | Target: ${data.target.message}`, 'success');
                    showToast('Connected to both instances!', 'success');
                } else {
                    let message = '';
                    if (!data.source.success) message += `Source: ${data.source.message}\n`;
                    if (!data.target.success) message += `Target: ${data.target.message}`;
                    showStatus('dualConnectionStatus', message, 'error');
                }
            } catch (error) {
                showStatus('dualConnectionStatus', 'Error: ' + error.message, 'error');
            }
        }

        async function previewAnnotations() {
            const sourceTaskId = document.getElementById('sourceTaskId').value;
            const sourceJobId = document.getElementById('sourceJobId').value;

            if (!sourceTaskId) {
                showStatus('copyStatus', 'Please enter source Task ID', 'error');
                return;
            }

            showStatus('copyStatus', 'Loading annotation preview...', 'info');

            try {
                const response = await fetch('/api/preview-annotations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_task_id: sourceTaskId,
                        source_job_id: sourceJobId || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayAnnotationPreview(data);
                    showStatus('copyStatus', `Loaded preview from ${data.source}`, 'success');
                } else {
                    showStatus('copyStatus', data.message, 'error');
                }
            } catch (error) {
                showStatus('copyStatus', 'Error: ' + error.message, 'error');
            }
        }

        function displayAnnotationPreview(data) {
            const summaryDiv = document.getElementById('previewSummary');
            summaryDiv.innerHTML = `
                <div class="stat-card primary">
                    <div class="stat-value">${data.total_frames}</div>
                    <div class="stat-label">Total Frames</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.total_files}</div>
                    <div class="stat-label">Annotated Files</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value">${data.total_shapes}</div>
                    <div class="stat-label">Shapes</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value">${data.total_tracks}</div>
                    <div class="stat-label">Tracks</div>
                </div>
            `;

            const filesDiv = document.getElementById('previewFiles');
            if (Object.keys(data.annotated_files).length === 0) {
                filesDiv.innerHTML = '<div class="empty-state"><p>No annotations found</p></div>';
            } else {
                filesDiv.innerHTML = Object.entries(data.annotated_files).map(([filename, info]) => `
                    <div class="preview-item">
                        <div>
                            <div class="preview-item-name">${filename}</div>
                            <div class="preview-item-meta">Frame: ${info.frame}</div>
                        </div>
                        <div class="preview-item-count">
                            <span style="color: var(--color-success);">${info.shapes.length} shapes</span>
                            <span style="color: var(--color-warning);">${info.tracks.length} tracks</span>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('annotationPreview').classList.add('visible');
        }

        async function previewTargetAnnotations() {
            const targetTaskId = document.getElementById('targetTaskId').value;
            const targetJobId = document.getElementById('targetJobId').value;

            if (!targetTaskId) {
                showStatus('copyStatus', 'Please enter target Task ID', 'error');
                return;
            }

            showStatus('copyStatus', 'Loading target annotation preview...', 'info');

            try {
                const response = await fetch('/api/preview-target-annotations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_task_id: targetTaskId,
                        target_job_id: targetJobId || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayTargetAnnotationPreview(data);
                    showStatus('copyStatus', `Loaded target preview from ${data.source}`, 'success');
                } else {
                    showStatus('copyStatus', data.message, 'error');
                }
            } catch (error) {
                showStatus('copyStatus', 'Error: ' + error.message, 'error');
            }
        }

        function displayTargetAnnotationPreview(data) {
            const summaryDiv = document.getElementById('targetPreviewSummary');
            summaryDiv.innerHTML = `
                <div class="stat-card warning">
                    <div class="stat-value">${data.total_frames}</div>
                    <div class="stat-label">Total Frames</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.total_files}</div>
                    <div class="stat-label">Annotated Files</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value">${data.total_shapes}</div>
                    <div class="stat-label">Shapes</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value">${data.total_tracks}</div>
                    <div class="stat-label">Tracks</div>
                </div>
            `;

            const filesDiv = document.getElementById('targetPreviewFiles');
            if (Object.keys(data.annotated_files).length === 0) {
                filesDiv.innerHTML = '<div class="empty-state"><p>No annotations found</p></div>';
            } else {
                filesDiv.innerHTML = Object.entries(data.annotated_files).map(([filename, info]) => `
                    <div class="preview-item">
                        <div>
                            <div class="preview-item-name">${filename}</div>
                            <div class="preview-item-meta">Frame: ${info.frame}</div>
                        </div>
                        <div class="preview-item-count">
                            <span style="color: var(--color-success);">${info.shapes.length} shapes</span>
                            <span style="color: var(--color-warning);">${info.tracks.length} tracks</span>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('targetAnnotationPreview').classList.add('visible');
        }

        async function previewMatches() {
            const sourceTaskId = document.getElementById('sourceTaskId').value;
            const sourceJobId = document.getElementById('sourceJobId').value;
            const targetTaskId = document.getElementById('targetTaskId').value;
            const targetJobId = document.getElementById('targetJobId').value;

            if (!sourceTaskId || !targetTaskId) {
                showStatus('copyStatus', 'Please enter both source and target Task IDs', 'error');
                return;
            }

            showStatus('copyStatus', 'Loading filename matches...', 'info');

            try {
                const response = await fetch('/api/preview-matches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_task_id: sourceTaskId,
                        source_job_id: sourceJobId || null,
                        target_task_id: targetTaskId,
                        target_job_id: targetJobId || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayMatchPreview(data);
                    showStatus('copyStatus', '', 'success');
                } else {
                    showStatus('copyStatus', data.message, 'error');
                }
            } catch (error) {
                showStatus('copyStatus', 'Error: ' + error.message, 'error');
            }
        }

        function displayMatchPreview(data) {
            const summaryDiv = document.getElementById('matchSummary');
            summaryDiv.innerHTML = `
                <div class="stat-card success">
                    <div class="stat-value">${data.matched_count}</div>
                    <div class="stat-label">Matched Files</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value">${data.unmatched_source_count}</div>
                    <div class="stat-label">Unmatched Source</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value">${data.unmatched_target_count}</div>
                    <div class="stat-label">Unmatched Target</div>
                </div>
            `;

            const detailsDiv = document.getElementById('matchDetails');
            let html = '';

            if (data.matched_files.length > 0) {
                html += '<h4 style="color: var(--color-success); margin-bottom: var(--space-3);">Matched Files</h4>';
                html += data.matched_files.map(match => `
                    <div class="preview-item" style="border-left: 3px solid var(--color-success);">
                        <div>
                            <div class="preview-item-name">${match.base_filename}</div>
                            <div class="preview-item-meta">Source: ${match.source}</div>
                            <div class="preview-item-meta">Target: ${match.target}</div>
                        </div>
                    </div>
                `).join('');
            }

            if (data.unmatched_source.length > 0) {
                html += '<h4 style="color: var(--color-warning); margin: var(--space-4) 0 var(--space-3);">Unmatched Source Files</h4>';
                html += data.unmatched_source.map(f => `<div class="preview-item" style="border-left: 3px solid var(--color-warning);">${f}</div>`).join('');
            }

            if (data.unmatched_target.length > 0) {
                html += '<h4 style="color: var(--color-danger); margin: var(--space-4) 0 var(--space-3);">Unmatched Target Files</h4>';
                html += data.unmatched_target.map(f => `<div class="preview-item" style="border-left: 3px solid var(--color-danger);">${f}</div>`).join('');
            }

            detailsDiv.innerHTML = html;
            document.getElementById('matchPreview').classList.add('visible');
        }

        async function copyAnnotations() {
            const sourceTaskId = document.getElementById('sourceTaskId').value;
            const sourceJobId = document.getElementById('sourceJobId').value;
            const targetTaskId = document.getElementById('targetTaskId').value;
            const targetJobId = document.getElementById('targetJobId').value;

            if (!sourceTaskId || !targetTaskId) {
                showStatus('copyStatus', 'Please enter both source and target Task IDs', 'error');
                return;
            }

            if ((sourceJobId && !targetJobId) || (!sourceJobId && targetJobId)) {
                showStatus('copyStatus', 'Both source and target must be at the same level', 'error');
                return;
            }

            const level = sourceJobId ? 'job' : 'task';
            showStatus('copyStatus', `Copying annotations at ${level} level...`, 'info');

            try {
                const response = await fetch('/api/copy-annotations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_task_id: sourceTaskId,
                        source_job_id: sourceJobId || null,
                        target_task_id: targetTaskId,
                        target_job_id: targetJobId || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus('copyStatus', `${data.message} - Copied ${data.annotations_count} annotations`, 'success');
                    showToast('Annotations copied successfully!', 'success');
                } else {
                    showStatus('copyStatus', data.message, 'error');
                }
            } catch (error) {
                showStatus('copyStatus', 'Error: ' + error.message, 'error');
            }
        }

        // ---- Video Analyzer Functions ----

        // File drop zone
        const dropZone = document.getElementById('videoDropZone');
        const fileInput = document.getElementById('videoFile');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                showToast(`Selected: ${files[0].name}`, 'info');
            }
        });

        async function analyzeVideo() {
            const file = fileInput.files[0];

            if (!file) {
                showToast('Please select a video file first', 'warning');
                return;
            }

            const detectionMethod = document.getElementById('detectionMethod').value;
            const sceneThreshold = document.getElementById('sceneThreshold').value;
            const motionThreshold = document.getElementById('motionThreshold').value;
            const minSceneLength = document.getElementById('minSceneLength').value;
            const targetFps = document.getElementById('targetFps').value;

            const formData = new FormData();
            formData.append('video', file);
            formData.append('method', detectionMethod);
            formData.append('scene_threshold', sceneThreshold);
            formData.append('motion_threshold', motionThreshold);
            formData.append('min_scene_length', minSceneLength);

            if (targetFps && targetFps > 0) {
                formData.append('target_fps', targetFps);
            }

            document.getElementById('videoAnalysisProgress').classList.add('visible');
            document.getElementById('videoResultsSection').style.display = 'none';

            const btn = document.getElementById('analyzeBtn');
            btn.classList.add('btn-loading');

            try {
                const response = await fetch('/api/analyze-video', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    videoAnalysisData = data;
                    displayVideoResults(data);
                    document.getElementById('videoAnalysisProgress').classList.remove('visible');
                    document.getElementById('videoResultsSection').style.display = 'block';
                    showToast('Video analysis complete!', 'success');
                } else {
                    showToast('Analysis failed: ' + data.message, 'error');
                    document.getElementById('videoAnalysisProgress').classList.remove('visible');
                }
            } catch (error) {
                showToast('Error analyzing video: ' + error.message, 'error');
                document.getElementById('videoAnalysisProgress').classList.remove('visible');
            } finally {
                btn.classList.remove('btn-loading');
            }
        }

        function displayVideoResults(data) {
            const info = data.video_info;
            let infoHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-3); font-size: var(--font-size-sm);">
                    <div><strong>Total Frames:</strong> ${info.total_frames}</div>
                    <div><strong>Original FPS:</strong> ${info.fps.toFixed(2)}</div>
                    <div><strong>Resolution:</strong> ${info.width}x${info.height}</div>
                    <div><strong>Duration:</strong> ${info.duration_seconds.toFixed(2)}s</div>
            `;

            if (info.target_fps) {
                infoHtml += `
                    <div><strong>Target FPS:</strong> ${info.target_fps.toFixed(2)}</div>
                    <div><strong>Analyzed Frames:</strong> ${info.analyzed_frames}</div>
                `;
            }

            infoHtml += '</div>';
            document.getElementById('videoInfoDisplay').innerHTML = infoHtml;

            document.getElementById('sceneCountDisplay').textContent = data.scene_count;
            document.getElementById('motionFramesDisplay').textContent = data.frames_with_motion;
            document.getElementById('staticFramesDisplay').textContent = data.frames_without_motion;
        }

        async function applyFrameFilter() {
            if (!videoAnalysisData) {
                showToast('Please analyze a video first', 'warning');
                return;
            }

            const filterMode = document.getElementById('filterMode').value;

            try {
                const response = await fetch('/api/filter-frames', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        motion_data: videoAnalysisData.motion_data,
                        scene_changes: videoAnalysisData.scene_changes,
                        filter_mode: filterMode
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayFilterResults(data);
                    showToast(`${data.count} frames selected`, 'success');
                } else {
                    showToast('Filter failed: ' + data.message, 'error');
                }
            } catch (error) {
                showToast('Error applying filter: ' + error.message, 'error');
            }
        }

        function displayFilterResults(data) {
            const totalFrames = videoAnalysisData.video_info.total_frames;
            const selectedCount = data.count;
            const removedCount = totalFrames - selectedCount;
            const removalPercentage = ((removedCount / totalFrames) * 100).toFixed(1);

            currentSelectedFrames = data.selected_frames;

            document.getElementById('selectedFrameCount').textContent = selectedCount;
            document.getElementById('removedFrameCount').textContent = `${removedCount} (${removalPercentage}%)`;

            document.getElementById('frameSummary').innerHTML = `
                <strong>Summary:</strong> ${totalFrames} original → ${selectedCount} selected<br>
                <strong>Removed:</strong> ${removedCount} frames (${removalPercentage}%)<br>
                <strong>Filter:</strong> ${data.filter_mode}
            `;

            const framesToShow = data.selected_frames.slice(0, 100);
            let frameListHtml = framesToShow.join(', ');
            if (data.selected_frames.length > 100) {
                frameListHtml += ` ... and ${data.selected_frames.length - 100} more`;
            }
            document.getElementById('selectedFrameList').textContent = frameListHtml;

            document.getElementById('filterResultsDisplay').style.display = 'block';
        }

        async function downloadSelectedFrames() {
            if (!currentSelectedFrames || currentSelectedFrames.length === 0) {
                showToast('No frames selected', 'warning');
                return;
            }

            const videoFile = fileInput.files[0];
            if (!videoFile) {
                showToast('Video file not available. Please re-analyze.', 'error');
                return;
            }

            const btn = document.getElementById('downloadFramesBtn');
            btn.classList.add('btn-loading');
            showToast(`Downloading ${currentSelectedFrames.length} frames...`, 'info');

            try {
                const formData = new FormData();
                formData.append('video', videoFile);
                formData.append('frame_indices', JSON.stringify(currentSelectedFrames));

                const response = await fetch('/api/download-video-frames', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `selected_frames_${Date.now()}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showToast(`Downloaded ${currentSelectedFrames.length} frames!`, 'success');
                } else {
                    showToast('Download failed', 'error');
                }
            } catch (error) {
                showToast('Error downloading frames: ' + error.message, 'error');
            } finally {
                btn.classList.remove('btn-loading');
            }
        }
    </script>
</body>
</html>
